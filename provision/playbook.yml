- name: Jenkins
  hosts: all
  become: true

  pre_tasks:
    - name: Pip
      apt: name=python-pip state=present

    - name: Docker-py
      pip:
        name: docker

    - name: Docker compose
      pip:
        name: docker-compose

  roles:
    - role: geerlingguy.docker
    
  tasks:
    - name: Config docker
      copy: 
        src: files/daemon.json
        dest: /etc/docker/daemon.json

    - name: Restart Docker
      shell: systemctl restart docker

    - name: Get docker info
      shell: docker info
      register: docker_info
      changed_when: false

    - name: Create primary swarm manager
      shell: docker swarm init
      when: "docker_info.stdout.find('Swarm: inactive') != -1"

    - name: Create secret user
      docker_secret:
        name: jenkins-user
        data: admin
        state: present

    - name: Create secret pass
      docker_secret:
        name: jenkins-pass
        data: adminpass
        state: present

    - name: Copy Compose file
      copy:
        src: ../app/docker-compose.yml
        dest: /home/docker-compose.yml
      
    - name: Start service
      docker_service:
        project_src: /home/
        state: present